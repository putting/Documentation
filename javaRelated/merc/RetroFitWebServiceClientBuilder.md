# RetroFitWebServiceClientBuilder

I think this is used in the classes generated by the RestGenerator class.
Importantly it creates the Retrofit instance and builds.
It adds interceptors for logging.
Has a number of optional buildig props like BasicAuth etc..

```java
package com.mercuria.dali.rest;

import com.fasterxml.jackson.databind.ObjectMapper;
import okhttp3.*;
import okhttp3.logging.HttpLoggingInterceptor;
import org.slf4j.Logger;
import retrofit2.Retrofit;
import retrofit2.converter.jackson.JacksonConverterFactory;
import retrofit2.converter.scalars.ScalarsConverterFactory;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

public final class RetrofitWebServiceClientBuilder<T, C> {

    private final String baseUrl;
    private final Class<T> serviceType;
    private final Logger logger;
    private final ClientBuilder<T, C> builder;

    private Interceptor authInterceptor = null;
    private ObjectMapper objectMapper = new ObjectMapper();
    private long timeout = TimeUnit.SECONDS.toMillis(30);
    private int maxRetries = 10;
    private Map<String, String> headers;
    private Interceptor headerInterceptor = null;
    private CookieJar cookieJar = CookieJar.NO_COOKIES;
    private Function<OkHttpClient.Builder, OkHttpClient.Builder> httpClientBuilderTransformer = Function.identity();
    private Function<Retrofit.Builder, Retrofit.Builder> retrofitBuilderTransformer = Function.identity();

    public RetrofitWebServiceClientBuilder(String baseUrl, Logger logger, Class<T> serviceType, ClientBuilder<T, C> builder) {
        this.baseUrl = baseUrl.endsWith("/") ? baseUrl : (baseUrl + "/");
        this.logger = logger;
        this.serviceType = serviceType;
        this.builder = builder;
        this.headers = new HashMap<>();
        this.headerInterceptor = chain -> chain.proceed(chain.request()
                .newBuilder()
                .headers(Headers.of(this.headers))
                .build());
    }

    public RetrofitWebServiceClientBuilder<T, C> withBasicAuth(String userName, String password) {
        String credential = Credentials.basic(userName, password);
        headers.put("Authorization", credential);
        return this;
    }

    public RetrofitWebServiceClientBuilder<T, C> withObjectMapper(ObjectMapper objectMapper) {
        this.objectMapper = objectMapper;
        return this;
    }

    public RetrofitWebServiceClientBuilder<T, C> withTimeout(long time, TimeUnit timeUnit) {
        this.timeout = timeUnit.toMillis(time);
        return this;
    }

    public RetrofitWebServiceClientBuilder<T, C> withMaxRetries(int maxRetries) {
        this.maxRetries = maxRetries;
        return this;
    }

    public RetrofitWebServiceClientBuilder<T, C> withHeaders(Map<String, String> headers) {
        checkNotNull("Headers", headers);
        this.headers.putAll(headers);
        return this;
    }

    public RetrofitWebServiceClientBuilder<T, C> withCookieJar(CookieJar cookieJar) {
        checkNotNull("cookieJar", cookieJar);
        this.cookieJar = cookieJar;
        return this;
    }

    public RetrofitWebServiceClientBuilder<T, C> withHttpClientBuilderTransformer(Function<OkHttpClient.Builder, OkHttpClient.Builder> httpClientBuilderTransformer) {
        checkNotNull("httpClientBuilderTransformer", httpClientBuilderTransformer);
        this.httpClientBuilderTransformer = httpClientBuilderTransformer;
        return this;
    }

    public RetrofitWebServiceClientBuilder<T, C> withRetrofitBuilderTransformer(Function<Retrofit.Builder, Retrofit.Builder> retrofitBuilderTransformer) {
        checkNotNull("retrofitBuilderTransformer", retrofitBuilderTransformer);
        this.retrofitBuilderTransformer = retrofitBuilderTransformer;
        return this;
    }

    public RetrofitWebServiceClientBuilder<T, C> withNoRetry() {
        this.maxRetries = 0;
        return this;
    }

    public C build() {
        HttpLoggingInterceptor interceptor = new HttpLoggingInterceptor(message -> {
            if (logger.isTraceEnabled()) {
                logger.trace(message);
            } else if (logger.isDebugEnabled()) {
                logger.debug(message);
            } else if (logger.isInfoEnabled()) {
                logger.info(message);
            }
        });
        if (logger.isTraceEnabled()) {
            interceptor.setLevel(HttpLoggingInterceptor.Level.BODY);
        } else if (logger.isDebugEnabled()) {
            interceptor.setLevel(HttpLoggingInterceptor.Level.HEADERS);
        } else if (logger.isInfoEnabled()) {
            interceptor.setLevel(HttpLoggingInterceptor.Level.BASIC);
        } else {
            interceptor.setLevel(HttpLoggingInterceptor.Level.NONE);
        }
        OkHttpClient.Builder clientBuilder = new OkHttpClient.Builder()
                .addInterceptor(interceptor)
                .readTimeout(this.timeout, TimeUnit.MILLISECONDS)
                .cookieJar(this.cookieJar);
        if (!this.headers.isEmpty()) {
            clientBuilder = clientBuilder.addInterceptor(this.headerInterceptor);
        }
        Retrofit.Builder builder = new Retrofit.Builder()
                .client(this.httpClientBuilderTransformer.apply(clientBuilder).build())
                .baseUrl(baseUrl)
                .addConverterFactory(ScalarsConverterFactory.create())
                .addConverterFactory(JacksonConverterFactory.create(this.objectMapper));
        T api = this.retrofitBuilderTransformer
                .apply(builder)
                .build()
                .create(serviceType);
        return this.builder.apply(api, this.objectMapper, this.maxRetries);
    }

    private static void checkNotNull(String field, Object obj) {
        if (obj == null) {
            throw new NullPointerException(field + " is null");
        }
    }

}
```
